# 学习数据整合说明

## 功能概述

首页总览现在会自动整合您所有的学习活动，包括：
- 📝 手动添加的练习记录
- 🎤 发音训练练习
- 📹 视频学习记录

所有数据都会统一显示在首页的趋势图表和记录列表中。

## 数据来源

### 1. 手动练习记录
**来源**：首页"新增记录"按钮手动添加

**特点**：
- 可以自定义日期、时长、备注
- 支持上传附件
- 可以编辑和删除

**显示格式**：
```
日期：2026-01-27
时长：30 分钟
备注：今天学习了商务英语对话
```

---

### 2. 发音训练记录
**来源**：发音训练模块完成练习后自动生成

**数据源**：`daily_practice_stats` 表

**特点**：
- 自动记录每日练习时长
- 显示完成进度和平均分数
- 不可编辑/删除（在原模块中管理）

**显示格式**：
```
日期：2026-01-27
时长：15 分钟
备注：发音训练：完成 8/10 词，平均分 85.5
```

**计算方式**：
- 时长 = `total_duration_seconds / 60`（转换为分钟）
- 进度 = `completed_count / target_count`
- 平均分 = `avg_total_score`

---

### 3. 视频学习记录
**来源**：每日视频模块观看视频后自动生成

**数据源**：`user_video_checkins` 表

**特点**：
- 自动记录观看时长
- 保留学习笔记
- 显示是否完成观看
- 不可编辑/删除（在原模块中管理）

**显示格式**：
```
日期：2026-01-27
时长：20 分钟
备注：视频学习（已完成）：学习了日常会话技巧
```

**计算方式**：
- 时长 = `watched_duration / 60`（转换为分钟）
- 完成状态 = `completed` 字段
- 笔记 = `notes` 字段

---

## 使用场景

### 场景一：查看整体学习进度
1. 登录后进入首页 Dashboard
2. 查看趋势图表，自动包含所有学习活动
3. 周度图表显示近4周的总学习时长
4. 月度图表显示全年的学习趋势

### 场景二：查看详细学习记录
1. 向下滚动到"练习记录"表格
2. 所有类型的记录按日期排序显示
3. 自动记录在"附件"列显示"自动记录"标签
4. 操作列对于自动记录显示"-"（不可操作）

### 场景三：补充手动记录
如果某些学习活动没有被自动记录（比如线下课程、自主阅读等），可以：
1. 点击"新增记录"按钮
2. 填写日期和时长
3. 添加备注和附件
4. 提交后会与自动记录一起显示

---

## 记录识别规则

系统通过记录ID前缀来识别记录类型：

| 前缀 | 类型 | 可编辑 | 可删除 | 可添加附件 |
|------|------|--------|--------|------------|
| 无前缀 | 手动记录 | ✅ | ✅ | ✅ |
| `pronunciation-` | 发音训练 | ❌ | ❌ | ❌ |
| `video-` | 视频学习 | ❌ | ❌ | ❌ |

---

## 数据同步说明

### 自动同步
- 发音训练：完成练习后实时同步
- 视频学习：打卡后实时同步
- 手动记录：提交后立即显示

### 刷新方式
- 首页会在加载时自动获取所有数据
- 如果需要手动刷新，可以切换到其他标签页再切回来
- 或者重新加载页面

### 数据延迟
- 正常情况下无延迟
- 如果发现数据未更新，请检查网络连接
- 或者登出后重新登录

---

## 常见问题

### Q1: 为什么有些记录不能编辑？
**A**: 发音训练和视频学习的记录是自动生成的，应该在对应的模块中进行管理。如需修改，请前往：
- 发音训练 → "发音训练"标签页
- 视频学习 → "每日视频"标签页

### Q2: 自动记录可以删除吗？
**A**: 不可以。自动记录是系统根据实际学习活动生成的，删除会导致统计数据不准确。如果某次练习有误，请在原模块中处理。

### Q3: 趋势图表包含哪些数据？
**A**: 包含所有三种类型的学习记录。时长会自动累加，所以您看到的是总学习时长。

### Q4: 如何区分不同类型的记录？
**A**: 通过备注内容：
- 发音训练：以"发音训练："开头
- 视频学习：以"视频学习"开头
- 手动记录：您自定义的备注内容

### Q5: 同一天可以有多条记录吗？
**A**: 可以。每天可能有：
- 1条发音训练统计（汇总当天所有发音练习）
- 1条或多条视频学习记录（每个视频一条）
- 任意数量的手动记录

---

## 技术细节

### 数据表关系
```
用户 (auth.users)
  ├── practice_records (手动记录)
  │   └── user_id → auth.users.id
  ├── daily_practice_stats (发音统计)
  │   └── user_id → auth.users.id
  └── user_video_checkins (视频记录)
      └── user_id → auth.users.id
```

### 查询逻辑
```javascript
// 1. 获取三个表的数据
const practiceRecords = await supabase
  .from("practice_records")
  .select("*")
  .eq("user_id", user.id)

const pronunciationStats = await supabase
  .from("daily_practice_stats")
  .select("*")
  .eq("user_id", user.id)

const videoCheckins = await supabase
  .from("user_video_checkins")
  .select("*")
  .eq("user_id", user.id)

// 2. 整合数据并按日期排序
const allRecords = [...practiceRecords, ...pronunciationStats, ...videoCheckins]
  .sort((a, b) => new Date(b.date) - new Date(a.date))
```

---

## 最佳实践

1. **保持学习习惯**：每天使用发音训练和视频学习功能，系统会自动记录
2. **补充细节**：对于重要的学习活动，使用手动记录添加详细备注和附件
3. **定期回顾**：利用趋势图表分析学习模式，调整学习计划
4. **避免重复**：不要为已自动记录的活动再次手动添加记录

---

## 数据隐私

- ✅ 所有记录仅对当前登录用户可见
- ✅ 其他用户无法查看您的学习数据
- ✅ 数据库层面通过 RLS 策略保护
- ✅ 自动记录和手动记录享有相同的隐私保护
