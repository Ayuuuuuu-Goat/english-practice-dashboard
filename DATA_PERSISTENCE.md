# 数据持久化说明

## ✅ 所有数据都已正确保存到 Supabase 数据库

### 1. 发音训练数据
**API**: `/api/pronunciation/evaluate`
**数据表**:
- `pronunciation_attempts` - 每次发音尝试的详细记录
  - 用户ID、单词卡片ID
  - 音频URL
  - 各项评分（总分、准确度、流畅度等）
  - 练习日期

- `daily_practice_stats` - 每日练习统计
  - 用户ID、练习日期
  - 完成次数
  - 平均总分
  - 总时长（秒）

**保存时机**: 每次完成发音评测后立即保存

---

### 2. 视频学习数据
**API**: `/api/video/checkin`
**数据表**:
- `user_video_checkins` - 每次视频打卡记录
  - 用户ID、视频ID
  - 观看时长
  - 打卡日期

- `user_video_stats` - 用户视频学习统计
  - 总观看视频数
  - 总观看时长
  - 当前连续天数
  - 最长连续天数
  - 最后打卡日期

**保存时机**: 每次视频打卡后立即保存并更新统计

---

### 3. AI 对话数据
**API**: `/api/conversation/save-result`
**数据表**:
- `conversation_session_results` - 对话会话结果
  - 用户ID、场景ID
  - 总分、语法分数、表达分数、结果分数
  - 最终结果（晋升/中立/失败）
  - 对话历史记录
  - 创建时间

**保存时机**: 每次完成对话场景后保存

---

### 4. HN 阅读数据
**API**: `/api/hn/reading`
**数据表**:
- `user_hn_stats` - HN阅读统计
  - 总阅读文章数
  - 当前连续天数
  - 最长连续天数
  - 最后阅读日期

**保存时机**: 每次阅读HN文章后更新

---

### 5. 用户认证数据
**存储位置**: localStorage (客户端)
- 当前登录用户角色信息
- 包含：姓名、邮箱、图标、颜色

**注意**: 这是唯一不在数据库中的数据，仅用于前端显示

---

## 📊 数据分析仪表盘数据来源

### 实时数据读取
仪表盘通过以下API从数据库实时读取数据：

1. **用户统计数据**: `/api/admin/all-users-stats`
   - 从 `daily_practice_stats` 读取发音数据
   - 从 `user_video_stats` 读取视频数据
   - 从 `user_hn_stats` 读取HN阅读数据
   - 从 `conversation_session_results` 读取对话数据
   - 从 `auth.users` 读取用户信息

2. **时间序列数据**: `/api/admin/timeline-stats?period=week|month|quarter|year`
   - 按日期聚合 `daily_practice_stats` 数据
   - 按日期聚合 `conversation_session_results` 数据
   - 生成趋势图表数据

### 数据更新频率
- **实时更新**: 每次用户操作后立即写入数据库
- **仪表盘刷新**: 页面加载时从数据库读取最新数据
- **时间维度切换**: 切换周/月/季/年时重新查询数据库

---

## 🔄 数据流程

```
用户操作
  ↓
前端组件调用API
  ↓
API验证并处理数据
  ↓
写入Supabase数据库
  ↓
数据持久化保存
  ↓
仪表盘实时读取展示
```

---

## ✨ 数据完整性保证

1. **时间戳**: 所有记录都包含日期/时间字段
2. **用户关联**: 所有数据都关联到具体用户ID
3. **统计更新**: 每次操作后自动更新聚合统计
4. **错误处理**: 数据库操作失败时有错误日志
5. **数据验证**: API层面验证必填字段

---

## 📝 总结

**所有学习数据都已完整保存到数据库**，包括：
- ✅ 发音训练记录和评分
- ✅ 视频学习打卡和时长
- ✅ AI对话会话和成绩
- ✅ HN文章阅读统计
- ✅ 每日练习汇总数据

**仪表盘显示的所有数据都来自数据库**，确保数据的持久性和准确性。
